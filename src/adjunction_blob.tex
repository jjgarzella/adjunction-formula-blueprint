

\subsection{Regular Rings}

We summarize things which have been proved in the previous section.

%There are two (very closely related)
%notions of ``smoothness'' given in Vakil Chatper 12.
%The one we need for this proof is ``regularity''.

\begin{proposition} \label{prop:regular_def_equiv}
   \uses{cor:local_maximal_gereating_set_basis_residue}
	Let \((R,\mathfrak{m},k)\) be a noetherian ring. 
	The following are equivalent:
	\begin{enumerate}[label=(\alph*)]
		\item Let \(n\) be the minimal number of generators of
			\(\mathfrak{m}\).
			Then \(n = \dim R\).
		\item \(\dim \mathfrak{m} / \mathfrak{m}^{2}  = \dim R\)
	\end{enumerate}
\end{proposition}

\begin{proof}
	It is enough to show that 
	\(\mu(\mathfrak{m}) = \dim \mathfrak{m} / \mathfrak{m}^{2}\),
	where \(\mu(\mathfrak{m})\) is the minimal number of generators
	of \(\mathfrak{m}\).
	
	First, we show \(\mu(\mathfrak{m}) \leq \dim \mathfrak{m} / \mathfrak{m}^{2}\).
	Let \(\overline{x}_{1}, \ldots, \overline{x}_{n}\) 
	be a basis of \(\mathfrak{m} / \mathfrak{m}^{2}\) 
	over \(k\).
	Then, by a corollary of Nakayama's lemma (Atiyah-MacDonald 2.8),
	the lifts of the \(\overline{x}_{i}\) generate \(\mathfrak{m}\),
	so \(\mu(\mathfrak{m}) \leq n\) as desired.

	Second, we show that 
	\(\dim \mathfrak{m} / \mathfrak{m}^{2} \leq \mu(\mathfrak{m})\).
	Let \(x_{1}, \ldots, x_{n}\) be a generating set of 
	\(\mathfrak{m}\).
	Then, the residues of the \(x_{i}\) generate 
	\(\mathfrak{m} / \mathfrak{m}^{2}\) (quotient map is a 
	homomorphism or something).
	Since it is a generating set, it contains a basis by
	linear algebra, and
	\(\dim \mathfrak{m} / \mathfrak{m}^{2} \leq n\) as desired.
\end{proof}

%The part that is needed in user6's proof is (b) in the proposition.
%I believe this is also what is used in Hartshorne II.8.17
%
%\begin{definition} \label{def:regular}
%	Let \(R\) be a noetherian local ring.
%	\(R\) is \textit{regular} if one (equivalently, all)
%	of the conditions from the previous proposition holds.
%\end{definition}

%The following lemma is used in the proof that the 
%conormal sequence is exact on the left by both 
%Hartshorne and user6.


\begin{lemma} \label{thm:regular_rings_localize}
	The localization of a regular local ring at (read: away from) a prime 
	ideal is a regular local ring.
\end{lemma}

%\begin{proof}
%	This proof uses two things
%	\begin{itemize}
%		\item Auslander-Buchsbaum-Serre
%		\item The localization of a projective resolution
%			is a projective resolution
%			(follows from the fact that localizations are exact)
%	\end{itemize}
%\end{proof}


\subsection{Misc Commutative Algebra}

\begin{lemma}
  \label{lem:finite_free_surj_splits}
  A surjection of finite free modules splits
\end{lemma}

\begin{lemma}
  \label{lem:rank_additive_exact_seq}
  Rank is additive on short exact sequences
\end{lemma}

\begin{theorem}
  \label{thm:hilbert_basis}
  Let $R$ be a noetherian ring.
  Then $R[x]$ is noetherian.
\end{theorem}

\begin{proof}
  The proof of this is already in mathlib:
  %polynomial.is_noetherian_ring
\end{proof}

%TODO: define a regular scheme using this as the local definition

%% Smooth morphisms
%
%\begin{proposition}
%	Let \(f: X \to Y\) 
%	be a map of schemes which is locally of finite
%	presentation (and thus locally of finite type).
%	The following are equivalent
%	\begin{enumerate}[(i)]
%		\item (Wikipedia Definition)
%			\(f\) is flat and for every geometric point
%			\(s : \overline{k} \to Y\), 
%			the fiber \(X_{s} := X \times_{Y} s\) 
%			is regular.
%		\item (Hartshorne Definition)
%			\(f\) is flat and the sheaf of relative
%			differentials \(\Omega_{X / Y}\) is 
%			locally free of rank equal to the 
%			relative dimension of \(f\).
%		\item (Vakil Definition)
%			For any \(x \in X\), there exists a neighborhood 
%			\(\Spec B\) of \(x\) and a neighborhood 
%			\(\Spec A\) of \(f(x)\) such that 
%			\(B = A[t_{1}, \ldots, t_{n}] / (P_{1}, \ldots, P_{m})\) 
%			and the Jacobian matrix has full rank, i.e.
%			the ideal generated by the \(m\)-by-\(m\) minors
%			of \((\partial P_{i} / \partial t_{j})\) is \(B\).
%			
%		\item \(f\) is formally smooth
%	\end{enumerate}
%\end{proposition}
%
%\begin{def}
%	If any of the previous conditions is satisfied, 
%	the map \(f\) is said to be a \textit{smooth} morphism
%	of schemes.
%\end{def}
%
%\begin{def}
%	A \(k\)-scheme \(X\) is  \textit{smooth over \(k\)} if 
%	the structure map \(X \to k\) is smooth.
%\end{def}

\subsection{Kahler differentials}

% I think this might be important for defining kahler 
%   differentials in lean
% https://math.stackexchange.com/questions/3783141/functoriality-of-the-module-of-k%C3%A4hler-differentials

\newcommand{\Der}{\operatorname{Der}}

We use the following strategy to define
the Kahler differentials:
first, we give the universal property, 
and then we give a few constructions that
satisfy the universal property

Let \(A\) be an \(R\)-algebra. 
\begin{definition} \label{def:derivation}
	An \(R\)-linear derivation of \(A\) into \(M\) 
	is a map of \(R\)-modules
	\(d \colon A \to M\) 
\end{definition}

The set of derivations is denoted \(\Der_{R}(A,M)\)

\begin{lemma} \label{lem:derivations_are_a_module}
	\uses{def:derivation}
	\(\Der_{R}(A,M)\) is an \(R\)-module.
\end{lemma}

\begin{proof}
	Derivations live in \(\Hom_{R} (A,M)\),
	so all we need to check is that 
	Leibnitz' rule still holds after addition,
	which we can do explicitly.
\end{proof}
% is this actually an \(A\)-module??

%TODO: fix this per zulip discussion
\begin{lemma} \label{lem:kahler_diff_module_representable}
	\uses{lem:derivations_are_a_module}
	The \textit{module of Kahler differentials}
	\(\Omega_{A / R}\) is the \(A\)-module that represents
	the functor \(M \mapsto \Der_{R}(A,M)\) 
	from \(A\)-modules to \(R\)-modules.
\end{lemma}


Of course as we define by universal property via representaility,
it is not clear that the module exists.

\begin{lemma} \label{lem:explicit_kahler_diff_free_quotient}
	\uses{lem:kahler_diff_module_representable}

	The following module satisfies the universal property 
	of \(\Omega_{R / A}\) :
	Take the free \(R\)-module on the symbols 
	\(da\) for \(a \in A\), and quotient
	out by the relations
	\begin{enumerate}[label=(\arabic*)]
		\item \(dr = 0\) for \(r \in R\) 
		\item \(d(a + a^{\prime}) = da + da^{\prime}\)
		\item \(d(aa^{\prime}) = 
			ada^{\prime} + a^{\prime}da\)
	.\end{enumerate}
\end{lemma}

We can state another version of the universal property:

\begin{lemma} \label{lem:kahler_diff_module_univ_prop}
	\uses{lem:kahler_diff_module_representable}

	The module of Kahler differentials has the following
	universal property: 
	The map \(d : A \to \Omega_{A / R}\) 
	defined by \(a \mapsto da\)
	is initial in
	the category whose objects are 
	derivations \(\delta : A \to M\) and
	morphisms are diagrams
	\[
	\begin{tikzcd}
	A \arrow{r}{\delta^{\prime}} \arrow{rd}{\delta} & 
	M^{\prime} \arrow{d}{} \\
	& M
	\end{tikzcd}
	\]
\end{lemma}

Finally, there is a second construction:
\begin{lemma}
	\label{lem:explicit_kahler_diff_I_mod_ISquared}
	\uses{lem:kahler_diff_module_univ_prop}
	
	Let \(I\) be the kernel of the multiplication
	map \(A \otimes_{R} A \to A\).
	Then \(I / I^{2}\) 
	satisfies the universal property of \(\Omega_{A / R}\)
\end{lemma}

\begin{proof}
	This proof (at least in Vakil) is a bit long, uses a lot 
	of properties of pure tensors, and I'm not sure
	if it's worth it.
\end{proof}

The following is quite important.
\begin{lemma}
	\label{lem:kahler_diff_commutes_with_loczn}
	\uses{lem:kahler_diff_module_univ_prop}
	By \(\phi\), we mean the ring map \(R \to A\) 
	given by the algebra structure
	Let \(S\) a multiplicative subset of \(A\),
	and let \(T\) be a multiplicative subset
	of \(R\) with \(\phi(T) \ins S\).
	Assume the following diagram commutes
	\[
	\begin{tikzcd}
	R \arrow{r}{} \arrow{d}[swap]{} &
	A \arrow{d}{} \\
	T^{-1}R \arrow{r}{} &
	S^{-1}A
	\end{tikzcd}
	\]
	
	We have a (canonical) isomorphism
	\[
	S^{-1}\Omega_{A / R} \isom
	\Omega_{S^{-1}A / T^{-1}R}	
	\] 
\end{lemma}

\begin{proof}
	TODO
\end{proof}

\begin{definition}
	\label{def:kahler_diff_sheaf}
	\uses{lem:kahler_diff_commutes_with_loczn}
	Given a map of schemes 
	\(X \to S\),
	we have a 
	sheaf \(\Omega_{X / S}\) 
	which globalizes the construction
	\(\Omega_{A / R}\).
\end{definition}

\begin{proof}
	Use the fact that 
	\(\Omega_{A / R}\)
	commutes with localization 
	plus general scheme machinery:
	if we have a sheaf on an affine 
	cover that is compatible on the intersections,
	then we get a sheaf on the whole scheme.
\end{proof}

\begin{lemma}
	\label{lem:kahler_diff_sheaf_quasi_coh}
	\uses{def:kahler_diff_sheaf}
	\(\Omega_{X / S}\) is quasi-coherent
\end{lemma}

\begin{proof}
	Use the fact that it is defined locally
	as a module.
	This is mathematically trivial but 
	is a good stress test of 
	``quasicoherent sheaf machinery''
	in Lean.
\end{proof}

\begin{proposition}
  \label{prop:conormal_seq_local}
  \uses{lem:kahler_diff_module_univ_prop}
  Let $B$ be an $A$-algebra, and $I$ some
  ideal of $B$.
  Let $C \colonequals B / I$.
  We have the following right-exact sequence:
  \[
    I / I^2 \to
    \Omega_{B/A} \otimes_B C \to
    \Omega_{C/A} \to 0
  \]
\end{proposition}

\begin{proof}

\end{proof}

\begin{corollary}
  [Hartshorne II.8.5]
  \label{cor:kahler_diff_fin_gen}
  If $B$ is a finitely generated 
  $A$-algebra or a localization thereof,
  then $\Omega_{B/A}$ is finitely generated
  as a $B$-module.
\end{corollary}

\begin{proof}
  \uses{
    lem:kahler_diff_commutes_with_loczn,
    prop:conormal_seq_local,
  }
  Calculate $\Omega_{B/A}$ for the 
  case of a polynomial ring.
  Then use the conormal sequence
  to pass to the quotient.
  Finally, Kahler differentials 
  commute with localization.
\end{proof}


\begin{corollary}
  \label{cor:kahler_diff_sheaf_coh}
  The sheaf of kahler differentials is
  coherent.
\end{corollary}

\begin{proof}
  \uses{
    lem:kahler_diff_sheaf_quasi_coh,
    cor:kahler_diff_fin_gen
  }
  Put together \ref{cor:kahler_diff_fin_gen}
  and \ref{lem:kahler_diff_sheaf_quasi_coh} 
\end{proof}

\begin{proposition}
  \label{prop:conormal_seq_sheaf}
  \uses{prop:conormal_seq_local}
  There is a sheafy exact sequence globalizing 
  \ref{prop:conormal_seq_local}
\end{proposition}

\begin{proof}
  \uses{lem:kahler_diff_commutes_with_loczn}
  We will need ideal sheaves for this.
\end{proof}


\begin{lemma}
  \label{lem:alg_clsd_is_perf}
  An algebraically closed field is perfect.
\end{lemma}

\begin{proof}
  Is this already in lean?
\end{proof}

\begin{definition}
  \label{def:sep_gen}
  A field extension $K/k$ is 
  \textit{separably generated}
  if there exists a trancendence basis
  $\{x_i\}$
  for $K/k$ such that
  $K$ is a separable algebraic extension
  of $k(\{x_i\})$.
\end{definition}

\begin{lemma}
  \label{lem:perf_is_sep_gen}
  Let $K/k$ be a perfect field extension.
  Then $K$ is separably generated over $k$.
\end{lemma}

\begin{lemma}
  [Hartshorne II.8.6A]
  \label{lem:kahler_diff_field_extension}
  \uses{def:sep_gen}
  Let $K$ be a finitely generated (as an algebra)
  field extension of $k$.
  Then $\trdeg K/k \leq \dim \Omega_{K/k}$,
  with equality 
  if (and only if) $K$ is separably
  generated over $k$.
\end{lemma}

\begin{theorem}
	[Hartshorne II.8.7]
	\label{thm:local_conormal_isom_kahler_tensor_residue}
	\uses{
    lem:explicit_kahler_diff_free_quotient,
    prop:conormal_seq_local,
  }
	Let \((B,\mathfrak{m},k)\) be a local ring 
	which contains a field \(k\) 
	isomorphic to its residue field
	% is this the right assumption?
	% should it really be equal characteristic?
	Then the map 
	\(\mathfrak{m} / \mathfrak{m}^{2} \to \Omega_{B / k} \otimes_{B} k\)
	which is the first map in the 
	conormal right-exact sequence
	is an isomorphism.
\end{theorem}

\begin{proof}
  %TODO
\end{proof}

\begin{lemma}
  [Hartshorne II.8.9]
  \label{lem:local_special_and_general_same_dim_implies_free}
  Let $A$ be a noetherian local integral domain,
  with residue field $k$ and 
  quotient field $K$.
  If $M$ is a finitely generated $A$-module
  and 
  $\dim_k M \otimes_A k = \dim_K M \otimes_A K = r$,
  then $M$ is free of rank $r$.
\end{lemma}

\begin{proof}
  \uses{cor:local_maximal_generating_set_basis_residue}
\end{proof}

\begin{theorem}
	[Hartshorne II.8.8]
	\label{thm:reg_loc_iff_free_kahler_diff_mod}
	Let \((B,\mathfrak{m},k)\) be a local ring of
	equal characteristic.
	% is this the correct assumption?
	% should it really be that it contains a field isomorphic to the residue field?
	In addition, assume that
	\(k\) is a perfect field,
	and that \(B\) is a localization of
	a finitely generatd \(k\)-algebra.
	Then \(\Omega_{B / k}\) is a free \(B\)-module
	of rank equal to the dimension of \(B\) 
	if and only if \(B\) is a regular local ring.

\end{theorem}

\begin{proof}
  \uses{
    lem:kahler_diff_commutes_with_loczn,
    prop:regular_def_equiv,
    lem:kahler_diff_field_extension,
    lem:alg_clsd_is_perf,
    lem:perf_is_sep_gen,
    lem:reg_int_dom,
    prop:conormal_seq_local,
    cor:kahler_diff_fin_gen,
    lem:local_special_and_general_same_dim_implies_free,
    thm:local_conormal_isom_kahler_tensor_residue,
  }
  This proof uses quite a few things.
\end{proof}


\begin{theorem}
  [Hartshorne II.8.15]
  \label{thm:regular_implies_kahler_diff_free}
  Let \(X\) be an irreducible separated scheme of finite type 
  over an algebraically closed field \(k\).
  Then \(\Omega_{X / k}\) is a locally free
  sheaf of rank \(\dim X\) if and only if 
  \(X\) is regular.
\end{theorem}

\begin{proof}
  \uses{
    thm:reg_loc_iff_free_kahler_diff_mod,
    thm:regular_rings_localize,
    cor:fintype_stalk_free_implies_locally_free,
  }


\end{proof}


%\subsection{Characteristic}


%Let \((R,\mathfrak{m},k)\) be a local ring.
%
%\begin{definition}
%	The \textit{natural characteristic} of \(R\) is
%	the smallest multiple of \(1\) that is equal to zero in \(R\).
%	If no multiple of \(1\) is equal to zero, then \(R\) is
%	defined to have characteristic \(0\)
%	It is denoted \(\ch R\).
%\end{definition}
%
%\begin{lemma}
%	If \(R\) is an integral domain, 
%	\(\ch R = \ch \Frac(R)\).
%\end{lemma}
%
%\begin{definition}
%	The \textit{residue charateristic} of \(R\) is
%	\(\ch k\).
%\end{definition}
%
%\begin{definition}
%	The \textit{characteristic} of \(R\) is the tuple
%	\((\ch R, \ch k)\).
%\end{definition}
%
%\begin{definition}
%	\(R\) is of \textit{equal characteristic} if
%	\(\ch R = \ch k\).
%\end{definition}
%
%\begin{definition}
%	\(R\) is of \textit{mixed characteristic} if
%	\(\ch R \neq \ch k\)
%\end{definition}
%
%\begin{lemma}
%	For any local ring \(R\), \(\ch R\) must be \(0\) or \(p\) 
%	for \(p\) a prime number.
%\end{lemma}
%
%\begin{lemma}
%	\(R\) is of equal characteristic if and only if 
%	\(R\) contains a field.
%\end{lemma}
%
%\begin{lemma}
%	If \(R\) is of mixed characteristic, then the characteristic
%	of \(R\) is \((0,p)\) for some prime \(p\).
%\end{lemma}
%
%Question: Is it possible to have a local ring 
%of equal characteristic which 
%contains a field, but does not contain its residue field?
%
%

%\subsection{Regularity implies conormal sequence is left-exact}

% I think the following is just wrong,
%   TODO: delete this when the proof of Hartshorne II.5.7 is finished
%\begin{lemma}
%	[Pulling back equations along a ring homomorphism]
%	Let \(R, R^{\prime}\) be \(A\)-algebras.
%	Let \(f : R \to R^{\prime}\) be an \(A\)-linear ring homomorphism.
%	Assume that we have a system of equations in \(R^{\prime}\),
%	i.e.
%	\[
%	\sum_{i}^{} a_{ij}r_{i}^{\prime} = 0 
%	\] 
%	for some \(r_{i}^{\prime} \in R^{\prime}\).
%	Assume that each \(r_{i}^{\prime}\) has a preimage,
%	i.e. \(f^{-1}(r_{i}^{\prime}) \neq \emptyset\) 
%	for all \(i\).
%	Then, there exists a simultaneous pullback of
%	the equations,
%	i.e.
%	there exists \(s_{i} \in R\) such that
%	\(f(s_{i}) = r_{i}^{\prime}\),
%	such that
%	\(\sum_{i}^{} a_{ij}s_{i} = 0 \) in \(R\).
%\end{lemma}
%
%\begin{proof}
%	Let \(r_{i}\) be a preimage of \(r_{i}^{\prime}\) 
%	in \(R\) (for all \(i\)).
%	Then, we can write
%	\[
%	\sum_{i}^{} a_{ij}r_{i} + k_{i} = 0 
%	\] 
%	for all \(j\), for \(k_{i} \in \Ker f\).
%	Now, the proof is to ``inductively
%	fold the \(k_{i}\) into \(r_{1}\)''.
%	This means that one defines
%	\(s_{1}^{1}\) to be \(r_{1 + }\)
%
%\end{proof}

%\subsection{Noetherian Schemes}


%
%\begin{theorem}
%	[Hartshorne II.8.17]
%	Let \(X\) be a regular variety over \(k\).
%	Let \(W\) be an irreducible closed subscheme 
%	with corresponding sheaf of ideals \(\mathscr{I}\).
%	Then \(W\) is regular if and only if the following
%	two conditions hold:
%	\begin{enumerate}[(1)]
%		\item \(\Omega_{Y / k}\) is locally free
%		\item The conormal exact sequence
%			\[
%			\begin{tikzcd}
%			0 \arrow{r}{} & \conormal \arrow{r}{} & 
%			\Omega_{X / k} \otimes \mathcal{O}_{Y}  \arrow{r}{} & 
%			\Omega_{Y / k} \arrow{r}{} & 0
%			\end{tikzcd}
%			\]
%			is exact.
%	\end{enumerate}
%\end{theorem}
%
%\begin{cor}
%	In the situation of the conclusion of the previous theorem, 
%	\(\mathscr{I}\) is locally generated by 
%	\(\codim(W)\) elements.
%\end{cor}
%
%\begin{cor}
%	In the situation of the conclusion of the previous theorem,
%	\(\conormal\) is locally free of rank \(\codim(W)\).
%\end{cor}
%

\subsection{Coherent Sheaves and Stalks}

\begin{definition}
	\label{def:noetherian_scheme}
	Let \(X\) be a scheme. 
	We say \(X\) is \textit{locally noetherian}
	if there exists an open affine cover
	\(\{U_{i} = \Spec A_{i}\}\) such that
	all \(A_{i}\) are noetherian rings.
\end{definition}

\begin{lemma}
  \label{lem:stalks_preserve_colimits}
  The functor on sheaves of abelian groups
  (and in particular, quasi-coherent sheaves)
  on a scheme $X$
  which takes a sheaf $\mathcal{F}$ to its
  stalk at the point $x$, $\mathcal{F}_x$,
  is a functor that preserves colimits.
\end{lemma}

\begin{proof}
  Taking stalks is itself a colimit, and
  colimits commute with colimits.
\end{proof}

\begin{theorem}
  \label{thm:stalk_exact_iff_sheaf_exact}
  \uses{lem:stalks_preserve_colimits}
  Consider an exact sequence of abelian (coherent) sheaves
  on a scheme.
  Can be left-exact, right-exact, exact in the middle,
  short exact, longer, anything.
  The seqeunce is exact iff it exact on all stalks.
\end{theorem}

\begin{corollary}
  \label{cor:stalk_preserves_quotients}
  \uses{thm:stalk_exact_iff_sheaf_exact}
  A stalk of a quotient of ideal sheaves
  is isomoprhic to the quotient of the stalks
  of the ideal sheaves.
\end{corollary}


\begin{lemma}
	\label{lem:affine_stalk_free_implies_locally_free}
	Let \(A\) be a ring, and \(M\) an \(A\)-module.
	Suppose that, for some prime ideal \(\mathfrak{p}\),
	\(M_{\mathfrak{p}}\) is a free
	\(A_{\mathfrak{p}}\)-module.
	Then there exists an element 
	\(f \in A \smallsetminus \mathfrak{p}\)
	such that 
	\(M_{f}\) is a free \(A_{f}\)-module.
\end{lemma}

\begin{proof}
	This is exactly the same proof
	as the next lemma, minus the reduction
	to being an affine scheme.
\end{proof}



%TODO: put most of the proof of this into the affine version above

\begin{theorem}
	[Hartshorne Exercise II.5.7a]
	\label{thm:stalk_free_implies_locally_free}
	\uses{lem:affine_stalk_free_implies_locally_free}

	Let \(X\) be a locally noetherian scheme, and let
	\(\mathcal{F}\) be a coherent sheaf. 
	If the stalk \(\mathcal{F}_{x}\) is a free
	\(\mathcal{O}_{X,x} \)-module for some point
	\(x \in X\), then there exists
	a neighborhood \(U\) containing \(x\) such that
	\(\mathcal{F}|_{U}\) is free.
\end{theorem}

\begin{proof}
   \uses{def:noetherian_scheme}
	WLOG, we can assume that \(X\) is affine, so 
	\(X = \Spec A\), and furthermore we can assume
	\(A\) is noetherian.
	Indeed, take an open affine noetherian cover 
	as guarenteed by local noetherianity. 
	Then \(x\) is contained in some neighborhood
	\(U = \Spec A\) in the cover. 
	% this is a (re)definiton of \Spec A, a slight abuse
	%   of notation
	If we show the theorem for \(\Spec A\),
	then we have shown it for \(X\).

	Now, as \(\mathcal{F}\) is a coherent sheaf on 
	\(A\), \(\mathcal{F} \isom \tilde{M}\) for some
	finitely generated module \(M\) on \(A\).
	\(x\), being a point of \(\Spec A\), 
	is/corresponds to a prime
	ideal \(\mathfrak{p}\) in \(A\).
	Now, our assumption about
	freeness of the stalk says that
	\(M_{\mathfrak{p}} \isom A_{\mathfrak{p}}^{\oplus n}\) 
	for some \(n\).
	Indeed, \(M_{\mathfrak{p}}\) is the stalk of 
	\(\tilde{M}\) and \(A_{\mathfrak{p}}\) is the local
	ring of \(\Spec A\) at \(\mathfrak{p}\).
	Let \(m_{1} , \ldots , m_{n}\) the a 
	basis/free generating set for \(M_{\mathfrak{p}}\).
	In other words, \(m_{i}\) is the image 
	(along
	some isomorphism \(A_{\mathfrak{p}}^{\oplus n}\)) of
	\((0, \ldots, 1, \ldots, 0) \in A_{\mathfrak{p}}^{\oplus n}\)
	where the \(1\) is in the \(i\)-th place.
	Since the \(m_{i}\) are elements of the stalk 
	\(\mathcal{F}_{x} \isom M_{\mathfrak{p}}\),
	we can choose a neighborhood \(U^{\prime}\) of \(x\) with 
	representatives \(m_{1}^{\prime}, \ldots, m_{n}^{\prime}\),
	whose images in the stalk are the \(m_{i}\).
	Indeed, we can do this individually for each \(m_{i}\),
	and since there are finitely many, 
	we can choose \(U^{\prime}\) a neighborhood which dominates each of them in 
	the diagram (i.e. a neighborhood which is contained in
	all of them, for example the intersection).
	Moreover, we can choose \(U^{\prime}\) to be affine by taking a 
	smaller neighborhood (\(X\) is a scheme).
	If we prove the theorem for \(U^{\prime}\), then we 
	have proven it for \(U\),
	so we can assume that \(U = U^{\prime}\).
	Aside: we can see that the \(m_{i}^{\prime}\) here aren't
	zero, because there is a ring map from the sections over
	\(U^{\prime}\) to the stalk, and the images are nontrivial in the stalk.


	Let \(x_{1}, \ldots, x_{k}\) be a finite generating set
	for \(M\).
	Now, we have the following equations in \(M_{\mathfrak{p}}\):
	\[
		\frac{x_{i}}{1} = \sum_{j=1}^{n} \frac{a_{ij}}{b_{ij}} m_{j} 
	.\] 
	Aside: if \(\frac{x_{i}}{1} = 0\), then all the \(a_{ij}\) are zero
	and the \(b_{ij}\) are \(1\) and the rest of the proof is
	not affected.

	Using the characterization of when elements of the localization 
	are zero (i.e. that they are \(s\)-torsion for some 
	\(s \in A \smallsetminus \mathfrak{p} \)),
	we have the equations
	\[
	t_{i}\prod_{}^{} b_{ij}
	\left(x_{i} - \sum_{j}^{} \frac{a_{ij}}{b_{ij}} m^{\prime}_{i}  \right)
	= 0
	\] 
	for some \(t_{i} \in A \smallsetminus \mathfrak{p}\),
	where the sum takes place in
	in \(M\) (which is a module over \(A\)).
	Note that we must have the factor of \(\prod_{}^{} b_{ij} \) as
	one multiply ``top and bottom'' by this term
	to put the element \(x_{i} - \sum_{}^{} \frac{a_{ij}}{b_{ij}}m_{i} \) 
	into the form \(\frac{p}{q}\) with \(p,g \in M\).

	Let \(b \colonequals \prod_{i}^{} t_{i}  \prod_{i,j}^{} b_{ij}\). 
	We know that the \(\frac{x_{i}}{1}\) generate \(M_{b}\) as an
	\(A_{b}\)-module by the characterization of elements in the localization
	as fractions (given an element of \(M {b}\), one has an equation
	in \(M\) for its numerator, and then one over its denominator 
	is in \(A_{b}\)).
	Thus, the equations above and the fact that 
	\(A \smallsetminus \mathfrak{p}\)-torsion is the 
	kernel of the localization map show that
	\(m_{i}^{\prime}\) generate \(M_{b}\). 

	Thus, we have that the following map
	\begin{align*}
		A_{b}^{\oplus n} &\longrightarrow M_{b} \\
		(0,\ldots,0,1,0,\ldots,0) &\longmapsto m_{i}^{\prime}
	\end{align*}
	is surjective (where the \(1\) is in the \(i\)-th place).
	Let the Kernel of the above map be denoted \(K\).
	We want to consider the exact sequence
	\[
	\begin{tikzcd}
	0 \arrow{r}{} & K \arrow{r}{} & 
	A_{b}^{\oplus n} \arrow{r}{} & M_{b} \arrow{r}{} & 0
	\end{tikzcd}
	.\]
	
	As \(A\) is noetherian, \(A_{b}\) is noetherian,
	and thus so is \(A_{b}^{\oplus n}\).
	Thus, \(K\), which is a submodule of \(a_{b}^{\oplus n}\),
	is finitely generated, say by 
	\(k_{1}, \ldots, k_{\ell}\).
	
	Now, we apply the localization functor to the above
	exact sequence. 
	However, we note that the second (nontrivial) map
	is indeed the same map as the isomorphism we
	gave in the first place.
	Thus, we conclude that \(K_{\mathfrak{p}} = 0\).
	This means, by the characterization
	of the kernel of a localization map,
	that there are \(s_{i} \in A \smallsetminus \mathfrak{p}\) 
	such that \(s_{i}k_{i} = 0\) in \(A\) for all \(i\).
	(the same is true if we replace  \(A\) with \(A_{b}\),
	one can use whichever ring is more convenient).
	Now, if we let 
	\(b^{\prime} = b \prod_{i}^{} s_{i} \),
	then we see that by the equations above
	and the characterization of the kernel of the localization
	as torsion, that
	\(K_{b^{\prime}} = 0\).
	This means, by the exact sequence above and/or the fact
	that kernels commute with localization,
	that \(A_{b^{\prime}}^{\oplus n} \isom M_{b^{\prime}}\),
	and we have what we want.
	
\end{proof}

\begin{corollary}
  \label{cor:fintype_stalk_free_implies_locally_free}
  \uses{thm:stalk_free_implies_locally_free,thm:hilbert_basis}
  Let $X$ be a variety over $k$.
  Same comclusion as above.
\end{corollary}

\begin{proof}
  $X$ has an affine cover of finite type $k$-algebras.
  Thus, by hilbert basis, it is (locally) noetherian.
  Apply the previous theorem.
\end{proof}

\subsection{Irreducible Schemes}

Let $|X|$ be a topological space.

\begin{definition}
  \label{def:irred_top_space}
  $|X|$ is irreducible if it cannot be written as a
  union of two closed subsets $ Z_1 \cup \Z_2$.
\end{definition}

\begin{lemma}
  \label{lem:irred_cap_open_is_irred_top_space}
  \uses{def:irred_top_space}
  Let $X$ be a suitable (noetherian? irred? zariski?)
  topological space. 
  Then the intersection of an open with an irreducible is irreducible.
\end{lemma}

Now, let $X$ be a scheme with $|X|$ its associated
topological space.

\begin{definition}
  \label{def:irred_scheme}
  \uses{def:irred_top_space}
  $X$ is irreducible if $|X|$ is.
\end{definition}

\begin{lemma}
  \label{lem:affine_cap_irred_is_affine}
  Let $X$ be a scheme, $U$ an affine open 
  neighborhood and $Y$ a closed (irreducible?) subscheme.
  Then $U \cap Y$ is an affine open neighborhood
  of $Y$
\end{lemma}

\begin{proposition}
  \label{prop:scheme_definullstellensatz}
  Let $X = \Spec R$ be an affine scheme.
  Then the irreducible subsets of the
  topological space $|X|$ are in one-to-one
  correspondence with the prime ideals of
  $R$ on the association 
  $\mathfrak{p} \mapsto V(\mathfrak{p})$.
\end{proposition}

\begin{proof}
  This statement looks a lot like the nullstellensatz,
  but it actually just follows straight from the
  definitions.
\end{proof}

\subsection{Left-exactness of conormal bundle}


\begin{lemma}
  \label{lem:reg_subvar_conormal_locally_free}
  Let $X$ be a regular variety, and let $Y$ be a regular
  subvariety.
  Let $\mathcal{I}$ be the ideal sheaf of $Y$.
  Then $\conormal$ is a locally free sheaf of rank 
  $\dim X - \dim Y$.
\end{lemma}

\begin{proof}
  \uses{
    lem:irred_cap_open_is_irred_top_space,
    prop:scheme_definullstellensatz,
    thm:regular_rings_localize,
    prop:regular_def_equiv,
    cor:fintype_stalk_free_implies_locally_free,
  }

  Let $U = \Spec R$ be an affine open neighborhood of $y$ in $X$.
  
  4. $U \cap Y$ is also affine and irreducible ($Y$ is irred)
     By Lemmas \ref{lem:irred_cap_open_is_irred_top_space}

  5. As $U \cap Y$ is irreducibe, it corresponds to a prime ideal
     $\mathfrak{p}$.
     By Lemma \ref{prop:scheme_definullstellensatz}.

     6. We work in the local ring of $X$ at $\mathfrak{p}$, which is $R_{\mathfrak{p}}$.
     Let $\mathfrak{m}$ be the maximal ideal $\mathfrak{p} R_{\mathfrak{p}}$.
     Then $\mathfrak{m} / \mathfrak{m}^2$ is a free 
     $R_{\mathfrak{p}} / \mathfrak{m}$ module of rank
     $\dim R_{\mathfrak{p}} = \text{ht} P = n-s$, where $n = \dim X$.
     By \ref{thm:regular_rings_localize} and \ref{prop:regular_def_equiv}


  7. Thus, by Hartshorne II.5.7 
     (\ref{cor:fintype_stalk_free_implies_locally_free}) 
     we have some $f$ not in $\mathfrak{p}$
     such that $(\mathfrak{p} / \mathfrak{p}^2)_f$ is free of rank $r$.
\end{proof}

\begin{theorem}
  \label{thm:regular_implies_conormal_exact}
  The conormal sequence is exact on 
  the left.
\end{theorem}

\begin{proof}
  \uses{
    lem:reg_subvar_conormal_locally_free,
    thm:regular_implies_kahler_diff_free,
    thm:stalk_exact_iff_sheaf_exact,
    cor:stalk_preserves_quotients,
    lem:stalks_preserve_colimits,
    lem:fin_gen_proj_over_local_is_free,
    lem:surj_endo_is_isom,
    lem:rank_additive_exact_seq,
    lem:fin_gen_proj_over_local_is_free,
    lem:finite_free_surj_splits
  }
  %This is the user6 prroof

  1. $Y$ is regular, therefore 
     $\Omega_{Y/k}$ is free of rank
     $s = \dim Y$.
     Likewise, $X$ is regular and
     $\Omega_{X/k}$ is free of rank
     $n = \dim X$.
  By Theorem \ref{thm:regular_implies_kahler_diff_free}
  
  2. We have the conormal exact sequence

  3. Take the stalk of this sequence at an
     arbitrary closed point $y \in Y$.
     By Theorem \ref{thm:exact_iff_sheaf_exact}

  3a. The stalk-taking/localization
      pulls into the $\mathcal{I} / \mathcal{I}^2$.
      By Corollary \ref{cor:stalk_preserves_quotients}

  3b. The stalk-taking/localization
      pulls into the restriction/tensor product
      in the middle of the sequence
      By Lemma \ref{lem:stalks_preserve_colimits} 
      (tensor is a colimit, in fact a pushout).
  
  Steps 4-7: Apply the previous lemma to conclude that
  $\conormal$ is locally free.

  Now, we have the conormal exact sequence localized at $y$:

  \[
    \mathcal{I}_y / \mathcal{I}^2_y 
    \to
    \Omega_{X/k,y} \otimes_{\mathcal{O}_{X,y}} \mathcal{O}_{Y,y} 
    \to
    \Omega_{Y/k,y} 
    \to 0
  \]

  8. The module in the middle of the (localized) exact sequence is free as it is 
     the localization of a free module. 

  8a. First, we see that $\Omega_{X/k} \otimes_{\mathcal{O}_X} \mathcal{O}_Y$ is a free module,
      first by using part 1 to see that $\Omega_X$ is free, then using that
      tensor products commute with direct sums to reduce to the case of $\mathcal{O}_X$,
      and finally using the identity property of the tensor product.
      (tensor product identity property will need to be proved, but it's not currently written down)

  8b. Then, we use the fact that localization pulls in/out of the construction (3b).

  Let $u$ be the surjective map in the (localized) conormal exact sequence.

  9.  Then $\Ker u$ is a projective module over $R_{\mathfrak{p}}$, as
      the exact sequence
      \[
        0 \to \Ker u \to 
        \Omega_{X/k,y} \otimes_{\mathcal{O}_{X,y}} \mathcal{O}_{Y,y} 
        \to
        \Omega_{Y/k,y} 
        \to 0
      \]
      splits (both of the second components are free).
      By \ref{lem:finite_free_surj_splits}

  10. $\Ker u$ is a (finitely generated) projective module over a local ring, it is free.
      By \ref{lem:fin_gen_proj_over_local_is_free}
      
  11. By the additivity of rank on exact sequences, $\Ker u$ has rank $n-s$.
      By \ref{lem:rank_additive_exact_seq}

  12. The first map of the localized conormal exact sequence is a surjection from
      $\mathcal{I}_y / \mathcal{I}^2_y$ and $\Ker u$. 
      Both of these are free modules of rank $n-s$. 
      By Nakayama's lemma (the endomorphism from free to free corollary),
      this is an isomoprhism.
      By \ref{lem:surj_endo_is_isom}

  13. Thus, on stalks the conormal sequence is exact on the left, so it is 
      exact globally.
      By Theorem \ref{thm:stalk_exact_iff_sheaf_exact}.
\end{proof}

%
%There are a few of this that I know of:
%
%Hartshorne's proof, which needs
%* nakayama's lemma (in mathlib)
%* integral schemes
%* a proper closed integral subscheme has codimension at least one
%https://math.stackexchange.com/questions/2372649/nakayamas-lemma-in-theorem-8-17-of-chapter-ii-in-hartshorne
%https://math.stackexchange.com/questions/3327995/some-fine-details-in-the-proof-of-hartshorne-ii-8-17
%* also requires Hartshorne II.5.7, Hartshorne II.8.8, Hartshorne II.8.7
%
%Vakil's proof, which needs
%* associated primes
%* geometric interpretation of associated primes
%
%There are also three other proofs from stack exchange,
%https://math.stackexchange.com/questions/846346/hartshorne-theorem-8-17
%
%Ignacio Barros's proof:
%* passes to stalks
%* needs Hartshorne II.8.7, which should be doable with just 
%   facts about differentials
%
%Tomo's proof:
%* Uses the concept of \textit{formally smooth} morphisms
%
%user6's proof:
%* passes to stalks, uses properties of free modules
%* uses Nakayama's lemma
%* requires Hartshorne II.5.7, which is proved here:
%https://dornsife.usc.edu/assets/sites/618/docs/Hartshorne\_Exercises.pdf
%* this also requires the following theorem:
%\begin{theorem}
%	Let \(f: M \to M\) be a surjective endomorphism of \(R\)-modules.
%	Then \(R\) is an isomoprhism.
%\end{theorem}
%The proof uses Nakayama's lemma, and this is precisely where we need it.
%This proof also uses the following:
%\begin{theorem}
%	Any finitely generated projective module over a local ring
%	is free.
%\end{theorem}
%And the proof supposedly uses Nakayama.
%
%
%
%% conormal exact sequence
%
%% Sketch of Hartshorne's proof:
%
%% stuff => smooth
%%  use nakayama's lemma, then compute the dimension of the z cotan space
%% smooth => stuff
%%  pick sub sheaf/variety for which it works on stalks, by first direction
%%  this is regular and irreducible.
%%  Then use the universal property integral closure (both schemes are integral)
%%  (probably using integral <==> reduced and irred)
%

\subsection{Main Proof}

%\subsection{Alternate description of the conormal sheaf}

%
%\begin{itemize}
%	\item restriction of sheaves
%	\item adjunction of pushforward of sheaves and pullback of sheaves
%	\item ideal sheaves
%	\item ``passing to stalks''
%\end{itemize}

\begin{theorem}
  \label{thm:alt_desc_conormal}
  Theorem statement here
\end{theorem}

\begin{proof}
  The proof of this is detailed in a nice amount of detail in
  stack overflow, see code comment
  %https://math.stackexchange.com/questions/1672117/conormal-bundle-of-cartier-divisors
\end{proof}

%
%Note that in the stack exchange article they prove more or less this 
%theorem for an arbitrary subvariety, and the part about divisors
%is only because of the alternate description of divisors as ideal sheaves.
%

%\subsection{The determinant bundle}

\begin{theorem}
  \label{thm:det_exact_sequence_tensor}
  Theorem statement here.

\end{theorem}


%\subsection{The Adjunction Formula}

% the end goal

\begin{theorem}[Adjunction Formula]
	\label{thm:adjunction_formula}
	Let \(X\) be a smooth variety and \(D\) a
	(smooth?) divisor. 
	Then 
	\[
    (\omega_{X} \otimes \mathcal{O}_X( D))|_{D} 
    \isom \omega_{D}
	\] 
	
\end{theorem}

\begin{proof}
  \uses{
    thm:det_exact_sequence_tensor,
    thm:alt_desc_conormal,
    thm:regular_implies_conormal_exact
  }
  We have an exact sequence
  \[
    0 \to \conormal \to 
    \Omega_X|_D \to \Omega_D \to 0
  \]
  from the conormal exact sequence, and
  it is exact on the left by 
  Theorem \ref{thm:regular_implies_conormal_exact}.
  We apply fact that the determinant is
  ``multiplicative'' on short exact sequences,,
  concluding that 
  \[
     \omega_D \otimes \conormal 
     \isom \omega_X|_D
   .\]
   Note that $\conormal$ has rank one, so it's 
   determinant bundle is itself.
   Finally,
   by the alternate description of the conormal
   sheaf (reference),
   we tensor both sides by 
   $\mathcal{O}_X(D)$ which is the inverse
   of the conormal sheaf, and we conclude the 
   thoerem.

\end{proof}


